# 目录级别分享功能说明

## 功能概述

系统现已支持**文件夹（目录）级别的分享**功能，不仅限于单个文件。你可以将整个文件夹作为一个单位进行分享并保存到资源库。

## 新增特性

### 1. 文件夹分享

✨ **支持分享整个文件夹**
- 文件夹会作为一个整体被分享
- 包含文件夹内的所有内容
- 自动创建分享链接并保存到数据库

✨ **智能识别类型**
- 文件：显示"分享文件"按钮
- 文件夹：显示"分享文件夹"按钮
- 为文件夹添加"打开"按钮，方便进入查看

### 2. 批量混合操作

✨ **支持文件和文件夹混合选择**
- 可以同时选择文件和文件夹
- 批量操作时自动识别类型
- 显示详细的统计信息

### 3. 增强的用户提示

✨ **明确的操作确认**
```
单个文件: "确定要分享文件《xxx》吗？"
单个文件夹: "确定要分享文件夹《xxx》吗？
             文件夹会作为一个整体分享，包含其中的所有内容。"

批量操作: "确定要批量分享已选择的 5 项吗？
           • 文件夹: 2 个
           • 文件: 3 个
           所有项目将被分享并保存到资源库。"
```

✨ **详细的结果反馈**
```
批量操作完成！

✅ 成功: 4 个
❌ 失败: 1 个

失败的项目:
某个文件名.mp4
```

## 使用场景

### 场景1：整季剧集分享

```
电视剧/
  ├── 第一季/
  │   ├── EP01.mp4
  │   ├── EP02.mp4
  │   └── ...
  └── 第二季/
      ├── EP01.mp4
      └── ...
```

**操作**:
1. 进入"电视剧"目录
2. 勾选"第一季"和"第二季"文件夹
3. 点击"批量分享并保存"
4. 两个文件夹作为独立资源保存

### 场景2：系列电影分享

```
电影系列/
  ├── 电影1.mp4
  ├── 电影2.mp4
  └── 电影3.mp4
```

**操作**:
1. 直接分享"电影系列"文件夹
2. 整个系列作为一个资源保存
3. 或者分别选择单个电影文件分享

### 场景3：混合内容分享

```
影视资源/
  ├── 单独电影.mp4
  ├── 剧集文件夹/
  └── 纪录片.mp4
```

**操作**:
1. 同时选择文件和文件夹
2. 批量分享，系统自动识别类型
3. 分别保存为独立资源

## 界面改进

### 文件列表显示

| 名称 | 大小 | 时间 | 操作 |
|------|------|------|------|
| 📁 电影文件夹 | - | 2025-01-05 | [分享文件夹] [打开] |
| 🎬 电影.mp4 | 2.5 GB | 2025-01-05 | [分享文件] |
| 📁 剧集文件夹 | - | 2025-01-04 | [分享文件夹] [打开] |

### 批量操作栏

```
已选择 3 个文件/文件夹
[批量分享并保存] [取消选择]
```

## 后端处理逻辑

### 1. 请求参数

```json
{
  "fid": "文件或文件夹的ID",
  "file_name": "名称",
  "is_dir": true  // 是否为文件夹
}
```

### 2. 处理流程

```
接收请求
  ↓
识别类型（文件/文件夹）
  ↓
调用 quark.share_dir([fid], file_name)
  ↓
获取分享链接
  ↓
保存/更新数据库
  - 文件夹: category2 = "文件夹资源"
  - 文件: category2 = "待分类"
  ↓
添加 TMDB 更新任务
  ↓
返回结果
```

### 3. 响应数据

```json
{
  "success": true,
  "message": "文件夹创建成功！",
  "resource_id": 123,
  "share_url": "https://pan.quark.cn/s/xxx",
  "item_type": "文件夹",
  "action": "创建"
}
```

## 数据库存储

### CloudResource 表

文件夹资源的特殊标记：

```python
{
  "drama_name": "文件夹名称",
  "drive_type": "quark",
  "link": "分享链接",
  "is_expired": 0,
  "category1": "影视资源",
  "category2": "文件夹资源",  # 文件夹特有标记
  "tmdb_id": None  # 后续更新
}
```

### 区分文件和文件夹

通过 `category2` 字段区分：
- `"文件夹资源"` - 文件夹
- `"待分类"` - 单个文件
- 其他 - 已分类的资源

## 日志输出示例

### 分享文件

```
[2025-01-05 10:00:00][INFO] 开始处理文件: 电影.mp4 (fid: xxx)
[2025-01-05 10:00:01][INFO] 正在分享文件: 电影.mp4
[2025-01-05 10:00:02][INFO] ✅ 文件分享成功: https://pan.quark.cn/s/xxx
[2025-01-05 10:00:02][INFO] 创建新资源: 电影.mp4 (ID: 123)
[2025-01-05 10:00:02][INFO] ✅ 已添加 TMDB 更新任务: 电影.mp4
[2025-01-05 10:00:02][INFO] ✅ 文件创建成功！
```

### 分享文件夹

```
[2025-01-05 10:00:00][INFO] 开始处理文件夹: 电视剧第一季 (fid: yyy)
[2025-01-05 10:00:01][INFO] 正在分享文件夹: 电视剧第一季
[2025-01-05 10:00:02][INFO] ✅ 文件夹分享成功: https://pan.quark.cn/s/yyy
[2025-01-05 10:00:02][INFO] 创建新资源: 电视剧第一季 (ID: 124)
[2025-01-05 10:00:02][INFO] ✅ 已添加 TMDB 更新任务: 电视剧第一季
[2025-01-05 10:00:02][INFO] ✅ 文件夹创建成功！
```

## 前端交互细节

### 1. 点击行为

**文件名区域**:
- 文件夹：点击进入目录
- 文件：点击无效果（仅显示）

**操作按钮**:
- "分享文件夹/文件"：执行分享操作
- "打开"（仅文件夹）：进入目录

### 2. 复选框选择

- 支持 Shift 键批量选择（浏览器原生）
- 支持 Ctrl/Cmd 键多选
- 勾选后显示操作栏

### 3. 批量操作

- 实时统计选中数量
- 区分文件和文件夹数量
- 顺序处理，避免并发问题

## 兼容性说明

### 向后兼容

✅ **完全兼容旧版本**
- 不传 `is_dir` 参数时默认为 `false`
- 旧的单文件分享功能正常工作
- 已有资源不受影响

### API 变化

```javascript
// 旧版本（仍然支持）
{
  "fid": "xxx",
  "file_name": "文件名"
}

// 新版本（推荐）
{
  "fid": "xxx",
  "file_name": "文件名",
  "is_dir": true  // 新增字段
}
```

## 最佳实践

### 1. 文件夹命名

推荐使用清晰的命名：
- ✅ `电影名称 (2024)`
- ✅ `剧集名称 第一季`
- ✅ `系列名称 合集`
- ❌ `新建文件夹`
- ❌ `未命名`

### 2. 目录组织

```
影视资源/
  ├── 电影/
  │   ├── 2024/
  │   └── 2023/
  ├── 剧集/
  │   ├── 美剧/
  │   └── 国产剧/
  └── 纪录片/
```

### 3. 批量操作建议

- 一次批量不超过 20 个项目
- 大批量建议分多次操作
- 注意观察成功/失败统计

## 故障排查

### 问题1：文件夹分享失败

**可能原因**:
- 文件夹为空
- 文件夹权限问题
- 网络超时

**解决方法**:
1. 确认文件夹包含文件
2. 检查夸克账号权限
3. 重试操作

### 问题2：批量操作部分失败

**可能原因**:
- 某些文件名包含特殊字符
- 分享配额不足
- 网络不稳定

**解决方法**:
1. 查看失败项目列表
2. 单独重试失败项
3. 检查后端日志

### 问题3：文件夹进入后返回失败

**可能原因**:
- 浏览器缓存问题
- 导航栈异常

**解决方法**:
1. 刷新页面
2. 清除浏览器缓存
3. 使用面包屑导航

## 性能优化

### 批量处理

- 串行处理，避免并发冲突
- 显示进度提示
- 失败项不影响后续处理

### 数据库操作

- 批量提交事务
- 复用数据库连接
- 索引优化查询

### 前端渲染

- 虚拟滚动（大文件列表）
- 延迟加载
- 缓存目录结构

---

**更新时间**: 2025-01-05
**版本**: v1.1.0
**新增功能**: 目录级别分享支持
