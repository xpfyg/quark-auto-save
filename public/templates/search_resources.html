<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>资源查询 - 夸克自动转存</title>
  <!-- 引入 Bootstrap CSS -->
  <link rel="stylesheet" href="./static/css/bootstrap.min.css">
  <link rel="stylesheet" href="./static/css/bootstrap-icons.css">
  <style>
    body {
      padding-bottom: 60px;
      background-color: #f8f9fa;
    }

    .search-card {
      background: white;
      padding: 30px;
      border-radius: 8px;
      margin-bottom: 30px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .resource-item {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }

    .resource-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .resource-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }

    .resource-meta {
      font-size: 14px;
      color: #6c757d;
      margin-bottom: 8px;
    }

    .quality-score {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-right: 8px;
    }

    .quality-excellent {
      background: #28a745;
      color: white;
    }

    .quality-good {
      background: #17a2b8;
      color: white;
    }

    .quality-normal {
      background: #ffc107;
      color: #333;
    }

    .quality-low {
      background: #6c757d;
      color: white;
    }

    .toast-container {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 9999;
    }

    .toast-message {
      min-width: 300px;
      margin-bottom: 10px;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      animation: slideIn 0.3s ease-out;
    }

    .toast-success {
      background: #28a745;
      color: white;
    }

    .toast-error {
      background: #dc3545;
      color: white;
    }

    .toast-info {
      background: #17a2b8;
      color: white;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }

      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .toast-message.hiding {
      animation: slideOut 0.3s ease-out;
    }

    .toast-icon {
      font-size: 24px;
      margin-right: 12px;
    }

    .toast-content {
      flex: 1;
    }

    .loading {
      text-align: center;
      padding: 50px;
      font-size: 18px;
      color: #6c757d;
    }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: #6c757d;
    }

    .empty-state i {
      font-size: 64px;
      color: #dee2e6;
      margin-bottom: 20px;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .spin {
      animation: spin 1s linear infinite;
      display: inline-block;
    }

    .navbar {
      margin-bottom: 20px;
    }
  </style>
</head>

<body>
  <div id="app">
    <!-- Toast 提示容器 -->
    <div class="toast-container">
      <div v-for="(toast, index) in toasts" :key="toast.id"
        :class="['toast-message', `toast-${toast.type}`, { hiding: toast.hiding }]">
        <i :class="['toast-icon', 'bi', toast.icon]"></i>
        <div class="toast-content">
          <strong>{{ toast.title }}</strong>
          <div v-if="toast.message">{{ toast.message }}</div>
        </div>
      </div>
    </div>

    <!-- 导航栏 -->
    {% include 'navbar_component.html' with context %}

    <div class="container">
      <h1 class="mb-4"><i class="bi bi-search"></i> 资源查询与转存</h1>

      <!-- 搜索卡片 -->
      <div class="search-card">
        <div class="form-group">
          <label for="searchInput"><strong>搜索资源</strong></label>
          <div class="input-group input-group-lg">
            <input v-model="searchQuery" @keyup.enter="searchResources" type="text" class="form-control"
              id="searchInput" placeholder="输入电影、剧集名称...">
            <div class="input-group-append">
              <button @click="searchResources" :disabled="searching || !searchQuery.trim()" class="btn btn-primary">
                <i class="bi bi-search"></i>
                <span v-if="searching">搜索中...</span>
                <span v-else>搜索</span>
              </button>
            </div>
          </div>
          <small class="form-text text-muted">
            <i class="bi bi-info-circle"></i> 提示：输入资源名称，系统将自动从多个网盘平台搜索并按质量排序
          </small>
        </div>

        <!-- 筛选选项 -->
        <div class="row mt-3">
          <div class="col-md-6">
            <label><strong>网盘类型</strong></label>
            <div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="quark" value="quark" v-model="cloudTypes">
                <label class="form-check-label" for="quark">夸克</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="aliyun" value="aliyun" v-model="cloudTypes">
                <label class="form-check-label" for="aliyun">阿里云盘</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="115" value="115" v-model="cloudTypes">
                <label class="form-check-label" for="115">115</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 加载中 -->
      <div v-if="searching" class="loading">
        <i class="bi bi-arrow-repeat spin"></i> 正在搜索资源...
      </div>

      <!-- 搜索结果 -->
      <div v-if="!searching && searchResults.length > 0">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5><i class="bi bi-list-ul"></i> 搜索结果 (共 {{ searchResults.length }} 条)</h5>
          <small class="text-muted">已按质量评分排序</small>
        </div>

        <div v-for="(item, index) in searchResults" :key="index" class="resource-item">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <div class="resource-title">
                <span class="badge badge-primary mr-2">#{{ index + 1 }}</span>
                {{ item.drama_name }}
              </div>
              <div class="resource-meta">
                <span class="quality-score" :class="getQualityClass(item.quality_score)">
                  质量评分: {{ item.quality_score }}
                </span>
                <span class="badge badge-secondary">{{ item.cloud_type }}</span>
                <span v-if="item.note" class="ml-2">
                  <i class="bi bi-card-text"></i> {{ item.note }}
                </span>
              </div>
              <div class="resource-meta mt-2">
                <i class="bi bi-link-45deg"></i>
                <a :href="item.link" target="_blank" class="text-primary">{{ item.link }}</a>
              </div>
            </div>
            <div class="ml-3">
              <button @click="openSaveModal(item)" :disabled="item.saving" class="btn btn-success">
                <i class="bi bi-download"></i>
                <span v-if="item.saving">转存中...</span>
                <span v-else>一键转存</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 空状态 -->
      <div v-if="!searching && searched && searchResults.length === 0" class="empty-state">
        <i class="bi bi-inbox"></i>
        <p>未找到相关资源，请尝试其他关键词</p>
      </div>

      <!-- 初始状态 -->
      <div v-if="!searching && !searched" class="empty-state">
        <i class="bi bi-search"></i>
        <p>在上方输入框中输入资源名称开始搜索</p>
      </div>
    </div>

    <!-- 转存确认模态框 -->
    <div class="modal fade" id="saveModal" tabindex="-1" role="dialog" aria-labelledby="saveModalLabel"
      aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="saveModalLabel">
              <i class="bi bi-download"></i> 确认转存
            </h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> 系统将自动转存该资源到您的夸克网盘
            </div>

            <div class="form-group">
              <label for="movieName"><strong>资源名称</strong></label>
              <input v-model="saveForm.movieName" type="text" class="form-control" id="movieName"
                placeholder="请输入或编辑资源名称">
              <small class="form-text text-muted">
                此名称将用于匹配 TMDB 信息和创建保存目录
              </small>
            </div>

            <div class="form-group">
              <label><strong>源链接</strong></label>
              <div class="input-group">
                <input :value="saveForm.link" type="text" class="form-control" readonly>
                <div class="input-group-append">
                  <a :href="saveForm.link" target="_blank" class="btn btn-outline-secondary">
                    <i class="bi bi-box-arrow-up-right"></i>
                  </a>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label><strong>网盘类型</strong></label>
              <input :value="saveForm.cloudType" type="text" class="form-control" readonly>
            </div>

            <div class="form-group">
              <label><strong>质量评分</strong></label>
              <div>
                <span class="quality-score" :class="getQualityClass(saveForm.qualityScore)">
                  {{ saveForm.qualityScore }} 分
                </span>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
            <button type="button" @click="confirmSave" :disabled="!saveForm.movieName.trim() || saveForm.saving"
              class="btn btn-success">
              <i class="bi bi-check-circle"></i>
              <span v-if="saveForm.saving">转存中...</span>
              <span v-else>确认转存</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 引入 Vue.js 和 Axios -->
  <script src="./static/js/vue@2.js"></script>
  <script src="./static/js/axios.min.js"></script>
  <script src="./static/js/jquery-3.5.1.slim.min.js"></script>
  <script src="./static/js/bootstrap.bundle.min.js"></script>

  <script>
    new Vue({
      el: '#app',
      data: {
        searchQuery: '',
        cloudTypes: ['quark'],  // 默认只搜索夸克
        searching: false,
        searched: false,
        searchResults: [],
        toasts: [],
        toastIdCounter: 0,
        saveForm: {
          movieName: '',
          link: '',
          cloudType: '',
          qualityScore: 0,
          saving: false,
          originalItem: null
        }
      },
      methods: {
        // Toast 提示方法
        showToast(title, message = '', type = 'info', duration = 3000) {
          const toast = {
            id: ++this.toastIdCounter,
            title,
            message,
            type,
            icon: type === 'success' ? 'bi-check-circle-fill' :
              type === 'error' ? 'bi-x-circle-fill' :
                'bi-info-circle-fill',
            hiding: false
          };

          this.toasts.push(toast);

          setTimeout(() => {
            toast.hiding = true;
            setTimeout(() => {
              const index = this.toasts.indexOf(toast);
              if (index > -1) {
                this.toasts.splice(index, 1);
              }
            }, 300);
          }, duration);
        },

        // 搜索资源
        async searchResources() {
          if (!this.searchQuery.trim()) {
            this.showToast('提示', '请输入搜索关键词', 'info', 2000);
            return;
          }

          if (this.cloudTypes.length === 0) {
            this.showToast('提示', '请至少选择一个网盘类型', 'info', 2000);
            return;
          }

          this.searching = true;
          this.searchResults = [];

          try {
            const response = await axios.get('/api/search_resources', {
              params: {
                keyword: this.searchQuery,
                cloud_types: this.cloudTypes.join(',')
              }
            });

            this.searchResults = response.data.results.map(item => ({
              ...item,
              saving: false
            }));
            this.searched = true;

            if (this.searchResults.length === 0) {
              this.showToast('未找到结果', '请尝试其他关键词', 'info');
            } else {
              this.showToast('搜索成功', `找到 ${this.searchResults.length} 条资源`, 'success', 2000);
            }
          } catch (error) {
            console.error('搜索失败:', error);
            this.showToast('搜索失败', error.response?.data?.error || error.message, 'error');
          } finally {
            this.searching = false;
          }
        },

        // 打开转存确认弹窗
        openSaveModal(item) {
          this.saveForm = {
            movieName: this.searchQuery,  // 默认使用搜索关键词
            link: item.link,
            cloudType: item.cloud_type,
            qualityScore: item.quality_score,
            saving: false,
            originalItem: item
          };
          $('#saveModal').modal('show');
        },

        // 确认转存
        async confirmSave() {
          if (!this.saveForm.movieName.trim()) {
            this.showToast('提示', '请输入资源名称', 'info', 2000);
            return;
          }

          this.saveForm.saving = true;
          const item = this.saveForm.originalItem;
          if (item) {
            item.saving = true;
          }

          try {
            const response = await axios.post('/api/save_resource', {
              movie_name: this.saveForm.movieName,
              link: this.saveForm.link,
              cloud_type: this.saveForm.cloudType
            });

            this.showToast('转存成功', response.data.message || '资源已成功转存', 'success');
            $('#saveModal').modal('hide');

            // 可选：转存成功后刷新搜索结果
            // this.searchResources();
          } catch (error) {
            console.error('转存失败:', error);
            this.showToast('转存失败', error.response?.data?.error || error.message, 'error');
          } finally {
            this.saveForm.saving = false;
            if (item) {
              item.saving = false;
            }
          }
        },

        // 获取质量等级样式
        getQualityClass(score) {
          if (score >= 100) return 'quality-excellent';
          if (score >= 70) return 'quality-good';
          if (score >= 30) return 'quality-normal';
          return 'quality-low';
        }
      }
    });
  </script>
</body>

</html>
